package com.company.service

import com.company.domain.SocialUser
import com.company.domain.UserContext
import com.company.domain.UserProfileRequest
import com.company.domain.UserProfileResponse
import com.company.entity.User
import com.company.exception.EntityNotFoundException
import com.company.exception.ForbiddenActionException
import com.company.repository.UserRepository
import org.springframework.stereotype.Service

@Service
class UserService(
    private val userRepository: UserRepository
) {

    private var AVATARS = listOf(
        "https://lh3.googleusercontent.com/35D3Ff_faStZ9-SfKYxTAduPSLUw1Ssn7_mHMk6PXJvWRy12lj3GJF3iJErBoxVU58VbuMKtY5GHhQfUFYXS0ZI1WON7R5Yyiwu2Y0kVXBjl4cLZ8wa_qrGAAeD_FE-x1CjeV_oSKXKwchHG81X96xMQr9vZgcSVdiQ1xbJif0Wru7abux11d5GzPkBVXH5XD1lJwyyYKNivQvnY_cmySIQo7fCeTu9rdCSEkkleax0-XBVgVczbDY5BOmdv-3V5-uv6svzNiUOAIMzRw4xqo6FSrEMV8P8bzilkGlh9Bi9y8J2uhs84OgOUhRsK0oquXdc8H8T2x9VquR1bEL72aAeH3lYBaIFqxjoG7BGsi8vyNzoHE9TsS217HCWTaQSLbuXbTUx9YUPrJzQFielo1mqKWCZLWXOZN6TPBgas8FNMwlEHnYMBqjw5IXU6CapyJm55ii8kHZPSmABroPcfzIBIWyvBQOHkreD29qzfotzEYqkr-y0g_hKjP8PKk6CDM9i-8nQ5-0ef6POwWPCNPX8eoDCs16RDEc_o7Hppy5WWiRUBzJPpteITQGJiHA8Nzy7-cnRx6yB1UVGdy_Kn0oUbsBZ3tVj1yzwJVt8Hha11V3MIWoVtklmiBSQEDrOCpX6JfX7ZtJZsS0LWaVr7BtP7HS6pC-zCt2tb6rQDi9uAJ3rt93095bh7F8PE6UOGqL3ViQE6W6vAzvBCFP3ZsVsN7plbcEsktysqXz6KIu_ilPTanwjeub0q1hCl6kycsfbWJwgiNlVNw0fT16hNeVjUAHuwjp-4DsyGdw41iHQZZIr2BQUUPPRX5ixYdYJwXCuv2WxJRz42uUsMMopX95gP94AzNQVFAF7ZOb3OlgHpVX_aOytXNQSJoUjuYLxb92UNzT4JF7bwzOpqg4Fw91OS8njVkcYEx_ACBqGLq-SnOCBW=s512-no?authuser=0",
        "https://lh3.googleusercontent.com/hnb4YvwYWEjx_28q0UjUDXx7AqK4TFfvTWNC558yujG2ox9iLDz8cQbyax6F_dX_i_H6GTx5zw-z2x0X6t3q_uXoeCxhXFU0l8ACHEzf5vhTEsXOuihXaoI8emwoqsdKn3-DQODO8FgFutw2lDZHV4ih4WXjwqP8_IX8Y4RCXv4HTV282c2DkAgnzFMKAtcWGwLERflLB4ZKnHa5uVRFU4toxht56Lkhh-GSiRiWlAZ7d4y2iEfZDrYEOVGIEFNyAmJa505rr0cRLVN85vdrjuFp1ipvYnT5BaBbgOFTYk5w_pt8mq40uw0vuYQ1r7wJL4Nv2pVADDJ4dZmzA_NHxFxIy2hzjnp8WWupT-MFnHCeGLCLm-BpMCjCGFHkEBlpIdgSB-iR4Wk3Ip4V4LcBS7BCtpXrT36dOyKpsMHMQ48-Guyl--qA3TjiaqYSq3ovjDLHVcD0SvtjkoxrijwmEI-QBypTnGxU29MUA9dauwFIk4fj1qUEjUxSy0deoaUFGUZLV4yTr-XEK9YwZuDrB2ntEcRxNk8ca2fIRj5Zzg43NaNzqZp3QuqzHvY7CM2cbxZE6N1ZA4V7uwoZ827b-SCgwE8EudTAWQNT3O6ydsuq8IziJuDV_SVoNco778D6I8yZfuFlybq35XDfQU5L6T2Soef2dqBCD9-ih8NJf3yyEklMzZen8MEJthYR3C-rMjN68y_tXcvHSDbxlfQSD8ba2pAp7f1R_kBMahlGZyxqR7ymPqWzWOeXlkKs0EvyNhzJzxwoBFetkbFRZtl2EVZi0fSzyPdN2iAfL0fhzpXjijekALzyW8bXEi1uiJdu7OMCaBzVFBDotXp95zg7utJnEd_P-1RPk9STXm8rvEWf0QGq2s4qXWAclzECWebzSJu2CiISxNANCrfBPV55nbSr6Z6PdvSpznmHy33aBwdY1hgi=s512-no?authuser=0",
        "https://lh3.googleusercontent.com/F4zk6uVlV_nJa4HbtYwbAkGBZrtZjneYyBOUGQKpmdvc8NAxy--NwKZWO_u4K8RPh5CIpxuomqd44XaQm3LvKm-F2cK6X3WxuVQ9MtAtjFqeR0YhDjngNlip8MvhdHh9G5CLeBfgyDn5WmdTSz20g-th_fpIXjp06RmOL11GT2nZH7pqVbO_zRpuGuFbZ75nR5sHfg0fRqY78rKnpGE_q2UoPppXwSQZlBWfws0l8yvdYUAplozLLkJ4E02WHJovxnyPGdzukKvXdPpm3BpGJo12Y85fftuap3TB8HOyqwCHVfkiSia8vWFoitFQqzR2zgxgC1ntI3Lufdx9I7wQCbb44pREXB7iQko7AUmdjoDPPI6Xa8fWqB5Ofw5QA0yzTqgCQMZlf6DG_qlVu0ZyrEmcrqLo4lprL-drsWHImGrV6Repem_PXPDshtW2nWSRmyA0YblSsve8Hmpzv-9n8o9XZID4iqxhCnLZAyu7bTqjGOs33ENPqD2oU4OJoAT00Q4NRf6KBaIEID4_rBNb1r2SRXPA98LLOlULVDBDTsnHuOwYgvLDBEvTG3Cke8yxmeqxjCJt-UVEgRYB8rOk6nkfHCW2Q4V0z6V3boe4zRnQk_fJsMJqiYJLYURGMUVR6uMvfNErSgtC6Zp8h3paNb9Z_Uf8XK9azZsmcwCMe_W6U7t6PWc7n0BpoNRujyi-E7ItyA9INf8LaYOI_2rZnYCj7oW-oYfXAnfTwD85e19Mbi_q2iEQXpaCi8tp4v3C5zoXFVW-wtk1d_DZkto67XyWubKD2CwY5Mm3NB3gtH7Y3-oTRG2whm3r0tKuHOZ88pm7D2LD-1qyWH2RPH5eKRuyG_qCEE-X5sD7SbJafAv7zo9MtqqRFtqoGx6GxTciqyLUld0-qaImZGTaVTNh4ZuEDzg2fsIbEGPqZJ0kq-RberoP=s512-no?authuser=0",
        "https://lh3.googleusercontent.com/Bbx67iwkGpwVzfctJVQspeKaNT-3dzt91llzfKRbP_-KUouwL-wQt8MxkGg_QVfbSfacCpnzsJXyB8-x3cYtO7dI--FX74JBhX4TIuMDK3se8fOv6GjLUxq_eZV-SmOfWvNWxtvbqC16J_FspeECffAaONiRyg5GDo-rUJI7H8F8iizH5_Gb29koyLsFgd3LlwZTw6crl1LvSOyxHiUap9H1uIqPmAeaeDuwiNlHwcg_XpVn3d6EKMpBfdEv-gmETqN1ULwjv17ZTVlEuXHGhem7Df-u1vfiVzcGYZWzAIsfKujbgeHbioPHswK2ImxeGPbFPhyKJGjUSWOMV5oVE9Hp3oyl4hMER638IZLFZMhzLYwZGQfI6tX98UEtUm90LUHoIQROIfgnqPFeis4Ealt5qxjNWRzmm41BuZwXEh52gZpR8pFBUSyboQbkgQPPNmyrNx28T3PQ6ZS8HUXnu9vyv9haixX5KRP4j8FQpAdpWBc94I7gviMkTUbtAcEZVE0czcIhpxbwKcjxbkxvnpc7XZZw40g4j14yvK3Jo4UbDjuSmZHIraZPZDWDb5OmdSYO2nERmHZ7OxPq425I1reie2BkGntzeTT9OWTFIB50TDnBLHR8kHmI-3Yli3G33pOU-krynxuRyPPIMS-jCTRqCTd-FtzZAK47NroY25r6urItTHRxXkIhzMyyUjG4QH4XmQ5FV1QHw9Y-7lA6m1WBJpW1UYzutvgJxEPQS6uaJtXPIlJjFUTsIiQ0CPhMzhUvmHF8y3kMlGLlqf1KRjEFp0v23s3acCUNvzszYUV9BB6zMm2grcSVqwN1cAtLJcjLf8lmmsjfyRoF2tD7eLa-w4hebZgA0TfqCv-qENTZJwMbVOkFuuG9cjMUftQHUtGY-R3GeCsEVLXFlY0x2JjsmlFcAIZHnm0ytq8a6PdnztfX=s512-no?authuser=0",
        "https://lh3.googleusercontent.com/iIH-RAD0ZZto1tPxgkaMsdzOyUGSitcpKmCxhw4k8OHZ6UrPQfbOnZ-1WK-HfH1V8c3WhceWeAL573RNks8phxaeWuVzapvmytFCcMXe9gIOgOmLCAxgboPEHfniygfEMRQAZQxcVqsfkeg-2ShF3bzZ2kIQrN6RJ3O4HVhpO7m7yDg62NgD0UnqkeJ_OwRkPUPrgKda1Sj_edBjsf9ZJn8B9Za1Olo15v_cWEjb8t619bk3vIYzhuWqqmJnMMd49K-R3f0EdfLc2PEOyPV0JToxeXa6jqdcW3PyKngp28fxY54TEX2riWhFnkRqK7Jjdnj5EI6WkASlkuqjuv0x-_hTjeUyY5RY_p5PQkP2FiKB0yXpB5U9XzaTjWHFpsxnVyTZ1qt6tIZIGpaQ-X9D-gtq1bucUDpwtzMhdEP1DlHg2z1LUOkn6XRmnz_RC_-iC_UDqYXc-Z3DL-lrcEj3qcz2I7SjWlkyPXSZfl7RBqm15JoYCOrU6vQLPNKEvKlZ7oxjdLFB5MgzYHi23GQEFra1KfAEr_y2RPWURUt5nS3eRgDtgj17D4DL6tXmvfWuD-B2UlMnt6DsFxPgW36j05qvlnjhsj8R1e56J7vUb8z7xKKhmsKEJnXGblRkEdWNokdt8NoOueZGH9FlK9i2tU7TNtcCEnkMeQ5USmM-Dd7n2Jw2NLRqINOYMvrOppMIi4zMF8ltsYTIy1qX5oEwUJT_UeMD5oXTHXVI1_k-F2O7SJuoqdwkxyHcmS_3MssiUa9fJT73ajvJNOK2L4zhXNIeAvwMM8Ohnj2WNTcRl66RZvP9UdzO9cXCp1aGkLRxMK3cOUvrH4mvFH5WHtiO2FtenEDAYJh2e5GhaLq5xeztumyv7mfo4wjU12vHkw_U0fFdmkH1lLX77mKo86yaTl_2GqzzRxwzKuxCPtTxpnpE7uEF=s512-no?authuser=0",
        "https://lh3.googleusercontent.com/YGhPQ_uw8nafpHCBvINMJYlwBMOSfUJaD6J8NXG67UOiZFyUzvwae6syWhu8U1RgkKGpIZgA-qpRZqXsLHG-gTCcEQ3hFpFVWWt-Mj1-AqfBwrLPHCon5mKDNEG934looJlpPYY7Xrq-h93E9JSWDu-_sJvDVivfvf9v5TRKeX_Ne-PRNcTFpukzo_i-52l8dU83u05CCJqdcfbsoP0DUvLATn8ztj05RTvBHIX8Wd5fxlc8PzqHVaqcqIDlP5S_7RNDUfw1Dyr5XUjLqnVi8G-ZRMCliPzFjNaXtPdpMu4YTchI_BqprhK6FCBv_Hy3ctg12HOt1GdXioiU1H8Bu19IYmEN-t8iBScebyxiTPTWtxKhIXifXV3SrXnwlhHjMAPG_Y13xR5z1n-CoPt5LzY40iDcu09PZ5qm1KrSU-E8FWhtZSPkGMcQAuJ8tu1E9KGcNx9jJuugOoKusHFAY8tzMC87d97hzn9_VKs2xKp29BSh-x7jjetpOjDKwBCVRokkRdnYbz1EBdQs9KabDxWEdcReIw5uzFK_Usfy29xrFA2KI4O_wGnOAFmxP80AVg0_cUq6YEl7evHh_L_XAJiMqige2dulCs4gzqmmVFg2HNHAbPUH3gGeLXDgFz3KbVW7kq2RH08ZLMV8D6cuwbnDZrEtwB-t_ISML84SC8RfFjTXWvzm0SrXf1OnyFnw7zOjsL3PSsUuabFOf6ugas7gJp1TT3zAarXJsqSnfABya7Kd5bdNgy3dwWS7kiVoVtYFSG_rxNTrPF0oMdi7a34b43DpRifrzvYa-_JNCz0oZWfBwPMM387MI1L1-m03WAyBp2sza8RkEx-h7IHfRxY41ybXsdJxaz8daA8h-0WJzD896h8hA_MUIySI6ZGfTAE4-MkH8FTf_wy3r8pDuEXeKetHlnVX8S8GG2LMvknsUckz=s512-no?authuser=0",
        "https://lh3.googleusercontent.com/eQ2-0_-LH3YpikpqHsFq6Bb3dTLMTQVJj2dzR5ucwwxglbqzo9HotcstvpnB6_wV4FZ5JRtY0nd4_tgcyKVVrLQLeD5AmVjhezMdJnyNdCLK_f7Dgncy2sQNylZKxDTZVWu3NVh0YdlmfE1h9JdpmMYsm_F3G7UldPk8UPxdYCzOSQXmED_q429OKzqbXJ3B4xW60u80P1Oe2urF3eg8Gagj8hmkhcsoeNXkhuvAlCaXgALM3f_DLyo5LEDEU9Nsl00skbUofTNWWHgYjwIoJT9aceWpp32lMTMtupdF0NCezW5iJPuBv1q83NZps5epXyxU_RqKvsCa0Kv2c1TwRl8Cu-1G11jC199hgNDogHrpTwZBp9agwPzahLXYFJLRZEQxx4yrZxK3UFurD8c3WJMTPuS3R-KM7g8fzyJ9SfX-8z9rW4lDXJzhGTTFJfw-BUsh28NsGX1AYhivwB2_S5Os372ebaEI3wCcoL8TTUxqrvkjSWju1d9lX91FZZLotaqEV3jyZy3NLMyJnBRRBUArn2x5Jip4m2Z-GrQNOyONFUMFmFbb7wcrir3DEVxzPZi1c3ci6ZiKoRq7fwTEvED1NKG7cJlK2g6Qvc0EcUStagfO7sKj3EuCxwn0GAO3gkxVdlN-Nc2CzS8s79pFRoaqDhE_F-XNMbXlKklI8-kvmeCorbRK2hdwr4PKH3DnfoAsIrRuHl9geSpyalabm3eyQiaHkviSzFtNrd2Z0AMOuGObICWqTj0cYXi0dAoGIt_2B1GIZJp90Sh9XKtm8TFPSYnRaa5FWNniLlb73QXes7TKFs6VUu6LttGIBpHdmapYiupRrnpI67raVxaydhN7m7ky8Kb8IueoUY_TdFmR0LAwqTgD7hjmVfc8Q7bWo4BLNnzTACdi-rnABYM--t0M5XyhN6iWaH4Yb1zj-lMQVIIY=s512-no?authuser=0",
        "https://lh3.googleusercontent.com/MTWaOQZ5yf8SYjSxgWTUeDk2X46r3Z5jEHkTaYqZ2Vj2dgnJG-JUZqUn1H7NhsDI5iVCdvmLjJFU5rbwWUCwsQlo59flk6o2tEFzGSLf0R-0WrCQtvlWVwUSVwH94ZS0Zb-HloMnYyQtJHQBBqlpCTHtRYBipD13YTjlzWsOfBXn3FfrT49JHOtDiBQqh4wcLcq1vWhuF_0AVZvL1NU5DX3WC_M2svqeMP_erxE3qRwt3hZewOHqVza07SjpZEbnlxbWeaQf45re9qzttwol1AmLVeX_EJ8LZM99LPe6Kz2DD0SCsWDFB5PRUSw22opyOSh8njD5AmFwCJRlqIKgn2rjK3R_5rVQ16284iIqYYcDGmjp5PrFF-FvYvRgK6wT8V0ocFemoJmKCjzJwiJbx7LfdcuO6XUpC4VCs584CPl7RGBFk7b-qqp5d_AuAaBTuvDecSV_XjFbhAw_nFYwXt1jzgjH6fOX3K8DpbDKeH0UqY_lYlo0zd9UpT7iq_rzKZVWh0oxkQ-7qPSHZBBRC4QTJOTy99vEn5UklNA4gJAJ3Gb2_pFjX_HGlRVOb4Ii6JcjHbygJTajVP_feuM41mw77Q8JWdXMjzc4bDwhG33N2WxOgo32dHyTjmrP7nlc4mSDIEKCD2oR7HYwhsZ10E6Ssf_9V2TbXwqe-TGT0u_66ZAR7THiozY5aOZUFNEPHgNXiTDiPFKMTechdgnTfXpX8duSPfTbXeztqoF8ae1A2kyujILl8S9U1KNmGBpSYLz7cEcIBxdZlLzF0mKOlagWVEwGZfvQc_Y4Z0_N1AJsWOTKCevXisUZ96G6ed6yudbgbeZEJ2RQnId-U9BAeAnw4LOqVzOfTSFh0iKb8oY-Drf260VR9TSMkDqRhEM0Ypa4don__tbYWF3fz-AmdV1ddZqhGuLRxvdzDN0aJyLkpA7_=s512-no?authuser=0",
        "https://lh3.googleusercontent.com/1CCg6wUxK8wl2YqhALKNzg-RE7KWmr05geJ7kVDRfU8kgG5I2pKS-zmGuH85KiBV6z3gTzHYItelmIIBviKT87M0TPQGyOnpxXolFaYyvIOdSu5znNLetw1s0NJlfSMsuEZLV-MkpIW7SrG70a6GLVW4aOtX2WRXDVLeMo8O3X8vxwg2xWc0hp_200tSPSIVlNcPK1LWPPqI74oKQOoOqrmAQ-RgFRpEmTr5zrzQh20tfL7LhkbIBr5WZor8as0R5yFqmSRmtMplzyDSah9xrP85myjC4ZlZPLYjjIuqUVrbYbp9v-X4iBmdX70hPaayKrI5L6BXw9kL0HMqaj2q1bYa3ILlesPgfJy2ZnKeAM0HgFxKhaw20-3H3XkwxdC68R9pXYu-3ktnjINNtpEFSc4Hu4H29I_dHKIMOhBbYkrvoyDokxtacG0B2ntpkVfzi8LXVk-mLpJ5GuXTwscpKrf-bLLED0tugID8evoOx0taBa9fILjerzUI_gUrnzwMSFGy8tgqDrwvS_q2vYXQ4Zy8Uct8GlHFXhTQDmr4KFc1oYVns2dWleemRYNBaSzQEG-pY5b956ttmGRNcOjPIDuq5PcUnEVTw1Y5CEMHBTgKlM_OpsnGMJSdaspys0O2T-6Q2_wspmh5iLMl7PLNcLWkjYr8pSCLxkrKMYQh9lxr6WDWnJ38zAJJO8mE6bLpcVtuq6pzNNgDqKgHcyqxl70gKM0EMwnARuNLbahaz8jFBFQ36-tCsBMsGRzdlOFObhb66ZAg-XaeoBRhKrTYc4uquNbLPJPWG2dmKkkVZJ_YGeqC2U6wPL92xiQRqyXh3Jjg-ZaFxjj-lMMQgjeCqYmQQYDyWLEBItbl1T38iHNqQHXkEgehmrwTwo-5Uo5Zx9yIEzcCxfCBCYUuyhkGCd3fOtsTxL4SXQXHewaLroAEDOyQ=s512-no?authuser=0",
    )

    fun createIfNotPresent(socialUser: SocialUser): String {
        val user = userRepository.findByEmail(socialUser.email)
        if (user != null) {
            return user.id
        }
        return userRepository.save(newUser(socialUser)).id
    }

    fun getCurrentReference(): User {
        return userRepository.getReferenceById(UserContext.getUserUuid())
    }

    fun get(userId: String): User {
        return getFromDb(userId)
    }

    fun getProfile(id: String): UserProfileResponse {
        val user = getFromDb(id)
        return map(user)
    }

    fun updateProfile(id: String, request: UserProfileRequest): UserProfileResponse {
        if (id != UserContext.getUserUuid()) {
            throw ForbiddenActionException("User $id is not authorized to perform action")
        }

        val user = getFromDb(id)
        user.username = request.username
        user.description = request.description
        user.githubLink = request.githubLink
        user.linkedinLink = request.linkedinLink
        user.skills = request.skills
        user.jobTitle = request.jobTitle

        return map(userRepository.save(user))
    }

    private fun getFromDb(id: String) = userRepository.findById(id).orElseThrow { EntityNotFoundException(id) }

    private fun map(user: User): UserProfileResponse {
        return UserProfileResponse(
            id = user.id,
            username = user.username,
            pic = user.pic,
            jobTitle = user.jobTitle,
            skills = user.skills,
            description = user.description,
            linkedinLink = user.linkedinLink,
            githubLink = user.githubLink
        )
    }

    private fun newUser(socialUser: SocialUser): User {
        val pic = AVATARS.random()
        return User(email = socialUser.email, username = socialUser.username, pic = pic)
    }
}
